<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Api Test</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="icon" href="images/favicon.png">
</head>

<body>
    <div>
        <table id="example" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>First</th>
                    <th>Last</th>
                    <th>Phone</th>
                    <th>Nat</th>
                    <th>Location</th>
                    <th>DOB</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin</th>
                </tr>
            </thead>

            <tfoot>
                <tr>
                    <th>First</th>
                    <th>Last</th>
                    <th>Phone</th>
                    <th>Nat</th>
                    <th>Location</th>
                    <th>DOB</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Admin</th>
                </tr>
            </tfoot>
        </table>
    </div>

    <button type="button" class="btn btn-default" id="adduser" data-toggle="modal" data-target="#regModal">Add a User</button>

    <div class="modal fade" id="regModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        Register User
                    </h4>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">

                    <form class="form-horizontal" id="addform">
                        <fieldset>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="fname">First Name</label>
                                <div class="col-md-4">
                                    <input id="first" name="first" type="text" placeholder="John" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Last Name</label>
                                <div class="col-md-4">
                                    <input id="last" name="last" type="text" placeholder="Doe" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Phone</label>
                                <div class="col-md-4">
                                    <input id="phone" name="phone" type="text" placeholder="xxx-xxx-xxxx" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Nationality</label>
                                <div class="col-md-4">
                                    <input id="nat" name="nat" type="text" placeholder="US" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">City</label>
                                <div class="col-md-4">
                                    <input id="city" name="city" type="text" placeholder="US" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Date of Birth</label>
                                <div class="col-md-4">
                                    <input id="dob" name="dob" type="text" placeholder="YYYY-MM-DD" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="email">Email</label>
                                <div class="col-md-4">
                                    <input id="email" name="email" type="text" placeholder="johndoe@example.com" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Username</label>
                                <div class="col-md-4">
                                    <input id="username" name="username" type="text" placeholder="johndoe7" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="password">Password</label>
                                <div class="col-md-4">
                                    <input id="password" name="password" type="password" placeholder="password" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="save"></label>
                                <div class="col-md-8">
                                    <button type="submit" id="save" name="save" class="btn btn-success">Register</button>
                                    <button id="clear" name="clear" class="btn btn-danger">Reset</button>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        Update User
                    </h4>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">

                    <form class="form-horizontal" id="updateform">
                        <fieldset>

                            <input type="hidden" id="oldid" name="_id">

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="fname">First Name</label>
                                <div class="col-md-4">
                                    <input id="newfirst" name="first" type="text" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Last Name</label>
                                <div class="col-md-4">
                                    <input id="newlast" name="last" type="text" placeholder="Doe" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Phone</label>
                                <div class="col-md-4">
                                    <input id="newphone" name="phone" type="text" placeholder="xxx-xxx-xxxx" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Nationality</label>
                                <div class="col-md-4">
                                    <input id="newnat" name="nat" type="text" placeholder="US" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">City</label>
                                <div class="col-md-4">
                                    <input id="newcity" name="city" type="text" placeholder="US" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Date of Birth</label>
                                <div class="col-md-4">
                                    <input id="newdob" name="dob" type="text" placeholder="YYYY-MM-DD" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="email">Email</label>
                                <div class="col-md-4">
                                    <input id="newemail" name="email" type="text" placeholder="johndoe@example.com" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="lname">Username</label>
                                <div class="col-md-4">
                                    <input id="newusername" name="username" type="text" placeholder="johndoe7" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="password">Password</label>
                                <div class="col-md-4">
                                    <input id="newpassword" name="password" type="password" placeholder="password" class="form-control input-md" required="">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-md-4 control-label" for="save"></label>
                                <div class="col-md-8">
                                    <button type="submit" id="save" name="save" class="btn btn-success">Update</button>
                                    <button id="clear" name="clear" class="btn btn-danger">Reset</button>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/bootbox.min.js"></script>
    <script>
        //table.row( '#myRowId' ).data( myUpdateObjectOrArray );
        //table.draw();
        //var data = table.rows( { selected: true } ).data()[0];
        //data.DT_RowId gives the required ID.
        function delete_users(del_id) {
            $.ajax({
                url: "./api.php/delete_user?_id=" + del_id,
                //url: "http://104.131.45.221/useradmin/api.php/delete_user/",
                type: 'DELETE',
                success: function (data) {
                    console.log(data);
                },
                data: []
            });
        }
        function get_users() {
            $.ajax({
                url: "./api.php/find_user/",
                //url: "http://104.131.45.221/useradmin/api.php/find_user/",
                type: 'GET',
                success: function (data) {
                    load_data_tables(data);
                },
                data: []
            });
        }
        function load_data_tables(data) {
            var filtered = [];
            var newobj = {
                "data": []
            };
            for (let i = 0; i < data.length; i++) {
                temp = [
                    data[i].first,
                    data[i].last,
                    data[i].phone,
                    data[i].nat,
                    data[i].city,
                    data[i].dob,
                    data[i].email,
                    data[i].username,
                    data[i].password,
                    '<i class="fa fa-pencil-square-o edit_user" aria-hidden="true" data-id="' + data[i]['_id'] + '"></i> <i class="fa fa-trash delete_user" aria-hidden="true" data-id="' + data[i]['_id'] + '"></i>'
                ];
                newobj["data"].push(temp);
            }
            var table = $('#example').DataTable({
                "data": newobj.data,
                "initComplete": function (settings, json) {
                    console.log('DataTables has finished its initialisation.');
                    add_admin_events();
                    $('#example tbody').on('click', 'tr', function () {
                        console.log(table.row(this).data());
                    });
                }
            });
            table.on('draw', function () {
                console.log('Table redrawn');
                add_admin_events();
            });
        }
        function add_admin_events() {
            $('.delete_user').click(function () {
                var $this = $(this);
                //Using bootbox for simplicity.
                bootbox.confirm("Are you sure?", function (result) {
                    if (result == true) {
                        delete_users($this.data().id);
                        location.reload();
                    }
                })
                console.log($this.data().id);
            });
            $('.edit_user').click(function () {
                var $this = $(this);
                $idinfo = $this.data().id;
                //Show the modal for updating a user
                $("#updateModal").modal("toggle");
                //Set the id so that the back end knows which entry to update
                $("#oldid").attr("value", $idinfo);
                //Fill the form so that the user can simply change entries to be changed.
                var table = $('#example').DataTable();
                $('#example tbody').on('click', 'tr', function () {
                    console.log(table.row(this).data());
                    document.getElementById("newfirst").defaultValue = table.row(this).data()[0];
                    document.getElementById("newlast").defaultValue = table.row(this).data()[1];
                    document.getElementById("newphone").defaultValue = table.row(this).data()[2];
                    document.getElementById("newnat").defaultValue = table.row(this).data()[3];
                    document.getElementById("newcity").defaultValue = table.row(this).data()[4];
                    document.getElementById("newdob").defaultValue = table.row(this).data()[5];
                    document.getElementById("newemail").defaultValue = table.row(this).data()[6];
                    document.getElementById("newusername").defaultValue = table.row(this).data()[7];
                    document.getElementById("newpassword").defaultValue = table.row(this).data()[8];
                });
            });
        }
        get_users();

        $('#updateform').submit(function (e) {

            var url = "./api.php/update_user/"; // the script where you handle the form input.
            console.log($("#updateform").serialize());
            $.ajax({
                type: "POST",
                url: url,
                data: $("#updateform").serialize(), // serializes the form's elements.
                success: function (data) {
                    alert(data); // show response from the php script.
                }
            });
            location.reload(); //Reload the page so that the table reflects changes.
        });

        // this is the id of the form
        $("#addform").submit(function (e) {

            var url = "./api.php/add_user/"; // the script where you handle the form input.
            console.log($("#addform").serialize());
            $.ajax({
                type: "POST",
                url: url,
                data: $("#addform").serialize(), // serializes the form's elements.
                success: function (data) {
                    alert(data); // show response from the php script.
                }
            });
            location.reload(); //Reload the page so that the table reflects changes.
        });

    </script>
</body>

</html>